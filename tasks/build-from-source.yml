---
# Install smartmontools from source
- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

# Install build dependencies
- name: Install build dependencies
  package:
    name:
      "{{ smartmontools_build_dependencies }}"
    state: present

# If running on a machine with systemd, install the development libraries
- name: Install systemd development libraries
  package:
    name:
      "{{ smartmontools_systemd_dev_libraries }} "
    state: present
  when: ansible_service_mgr == 'systemd' and smartmontools_install_systemd_stuff

# Download, configure, build and install
- name: Download smartmontools from Git
  git:
    repo: "https://github.com/smartmontools/smartmontools.git"
    dest: "{{ smartmontools_src_location }}"
    version: 'RELEASE_7_1'

- name: Run autogen.sh
  command: ./autogen.sh
  args:
    chdir: "{{ smartmontools_src_location }}/smartmontools"
    creates: "{{ smartmontools_src_location }}/smartmontools/configure"

- name: Run configure
  command: "./configure --with-nvme-devicescan"
  args:
    chdir: "{{ smartmontools_src_location }}/smartmontools"
    creates: "{{ smartmontools_src_location }}/smartmontools/Makefile"
